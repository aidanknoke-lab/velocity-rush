<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1000 Levels Parkour Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: linear-gradient(to bottom, #1a1a2e 0%, #16213e 100%);
            font-family: Arial, sans-serif;
            color: white;
            overflow-x: hidden;
        }

        #titleScreen, #endingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            animation: fadeIn 0.5s;
        }

        #endingScreen {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            display: none;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .game-title {
            font-size: 72px;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 4px 4px 8px rgba(0,0,0,0.5);
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .subtitle {
            font-size: 24px;
            color: white;
            margin-bottom: 40px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .start-button {
            padding: 20px 50px;
            font-size: 28px;
            font-weight: bold;
            background: #FFD700;
            color: #1a1a2e;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
            transition: all 0.3s;
        }

        .start-button:hover {
            background: #FFA500;
            transform: scale(1.1);
        }

        .menu-buttons {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .menu-button {
            padding: 15px 35px;
            font-size: 22px;
            font-weight: bold;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transition: all 0.3s;
        }

        .menu-button:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        .stats-container {
            background: rgba(0,0,0,0.6);
            padding: 30px 50px;
            border-radius: 20px;
            margin: 30px 0;
            text-align: center;
        }

        .final-stat {
            font-size: 32px;
            margin: 15px 0;
            color: #FFD700;
        }

        .final-stat span {
            color: white;
            font-weight: bold;
        }

        .ending-message {
            font-size: 48px;
            color: #FFD700;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
            margin-bottom: 30px;
            text-align: center;
            animation: celebration 1s infinite;
        }

        @keyframes celebration {
            0%, 100% { transform: rotate(-2deg); }
            50% { transform: rotate(2deg); }
        }

        .play-again-button {
            padding: 15px 40px;
            font-size: 24px;
            font-weight: bold;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
            transition: all 0.3s;
            margin: 10px;
        }

        .play-again-button:hover {
            background: #45a049;
            transform: scale(1.1);
        }

        .hidden {
            display: none !important;
        }

        #shopButton {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 30px;
            font-size: 20px;
            font-weight: bold;
            background: #FFD700;
            color: #1a1a2e;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transition: all 0.3s;
            z-index: 100;
            display: none;
        }

        #shopButton.show {
            display: block;
        }

        #shopButton:hover {
            background: #FFA500;
            transform: scale(1.05);
        }

        #shopModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }

        .shop-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 40px;
            border-radius: 20px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
        }

        .shop-title {
            font-size: 48px;
            color: #FFD700;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
        }

        .gem-balance {
            text-align: center;
            font-size: 32px;
            color: white;
            margin-bottom: 30px;
        }

        .gem-icon {
            color: #00CED1;
            font-size: 36px;
        }

        .skins-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .skin-card {
            background: rgba(0,0,0,0.4);
            border: 3px solid transparent;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .skin-card:hover {
            transform: translateY(-5px);
            border-color: #FFD700;
        }

        .skin-card.owned {
            border-color: #4CAF50;
        }

        .skin-card.equipped {
            border-color: #FFD700;
            background: rgba(255, 215, 0, 0.2);
        }

        .skin-preview {
            width: 80px;
            height: 80px;
            margin: 0 auto 10px;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .skin-pattern {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
        }

        .skin-name {
            font-size: 18px;
            font-weight: bold;
            color: white;
            margin-bottom: 5px;
        }

        .skin-price {
            font-size: 16px;
            color: #00CED1;
            margin-bottom: 10px;
        }

        .skin-button {
            padding: 8px 16px;
            font-size: 14px;
            font-weight: bold;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .buy-button {
            background: #FFD700;
            color: #1a1a2e;
        }

        .buy-button:hover {
            background: #FFA500;
        }

        .equip-button {
            background: #4CAF50;
            color: white;
        }

        .equip-button:hover {
            background: #45a049;
        }

        .equipped-button {
            background: #666;
            color: white;
            cursor: default;
        }

        .close-shop {
            display: block;
            margin: 20px auto 0;
            padding: 15px 40px;
            font-size: 20px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .close-shop:hover {
            background: #da190b;
        }

        #levelsModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }

        .levels-content {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            padding: 40px;
            border-radius: 20px;
            max-width: 900px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
        }

        .levels-title {
            font-size: 48px;
            color: white;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
        }

        .levels-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .level-button {
            padding: 20px;
            font-size: 18px;
            font-weight: bold;
            background: rgba(0,0,0,0.3);
            color: white;
            border: 3px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .level-button:hover {
            transform: scale(1.05);
            border-color: #FFD700;
        }

        .level-button.completed {
            background: rgba(76, 175, 80, 0.5);
            border-color: #4CAF50;
        }

        .level-button.current {
            background: rgba(255, 215, 0, 0.5);
            border-color: #FFD700;
        }

        .level-button.locked {
            background: rgba(0,0,0,0.5);
            color: #666;
            cursor: not-allowed;
        }

        .level-button.locked:hover {
            transform: none;
            border-color: transparent;
        }

        .level-gems {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 12px;
        }

        .back-button {
            display: block;
            margin: 20px auto 0;
            padding: 15px 40px;
            font-size: 20px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .back-button:hover {
            background: #0b7dda;
        }
        
        #gameCanvas {
            border: 3px solid #FFD700;
            background: linear-gradient(to bottom, #87CEEB 0%, #E0F6FF 100%);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        #hud {
            display: flex;
            gap: 30px;
            margin-bottom: 15px;
            background: rgba(0,0,0,0.7);
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 20px;
            font-weight: bold;
        }

        #gameContainer {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .stat-label {
            font-size: 14px;
            color: #FFD700;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 24px;
            color: #fff;
        }
        
        #controls {
            margin-top: 20px;
            text-align: center;
            background: rgba(0,0,0,0.7);
            padding: 15px;
            border-radius: 10px;
        }
        
        #controls h3 {
            margin-top: 0;
            color: #FFD700;
        }
        
        .key {
            display: inline-block;
            padding: 8px 12px;
            margin: 5px;
            background: #2a2a4e;
            border: 2px solid #FFD700;
            border-radius: 5px;
            font-weight: bold;
            color: white;
        }
        
        #message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.8);
            pointer-events: none;
            z-index: 1000;
        }

        .difficulty-indicator {
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 16px;
            font-weight: bold;
        }

        .easy { background: #4CAF50; }
        .medium { background: #FF9800; }
        .hard { background: #F44336; }
        .extreme { background: #9C27B0; }
        .impossible { background: #000; border: 2px solid #FF0000; }
    </style>
</head>
<body>
    <!-- Title Screen -->
    <div id="titleScreen">
        <div class="game-title">‚ö° VELOCITY RUSH ‚ö°</div>
        <div class="subtitle">Master 1000 levels of extreme parkour!</div>
        <button class="start-button" onclick="startGame()">START GAME</button>
        <div class="menu-buttons">
            <button class="menu-button" onclick="openShopFromMenu()">üíé SHOP</button>
            <button class="menu-button" onclick="openLevels()">üìã LEVELS</button>
            <button class="menu-button" onclick="toggleMusic()">üîä MUSIC: <span id="musicStatus">OFF</span></button>
        </div>
        <div style="margin-top: 40px; text-align: center; color: rgba(255,255,255,0.8);">
            <p>Use Arrow Keys or WASD to move</p>
            <p>Press SPACE or ‚Üë to jump</p>
        </div>
    </div>

    <!-- Ending Screen -->
    <div id="endingScreen">
        <div class="ending-message">üéâ CONGRATULATIONS! üéâ</div>
        <div class="game-title" style="font-size: 56px; margin-bottom: 20px;">YOU'VE MASTERED VELOCITY RUSH!</div>
        <div class="stats-container">
            <div class="final-stat">Levels Completed: <span id="finalLevel">1000</span></div>
            <div class="final-stat">Total Deaths: <span id="finalDeaths">0</span></div>
            <div class="final-stat">Total Time: <span id="finalTime">0</span></div>
        </div>
        <div style="display: flex; gap: 20px;">
            <button class="play-again-button" onclick="playAgain()">PLAY AGAIN</button>
            <button class="play-again-button" style="background: #2196F3;" onclick="backToMenuFromEnd()">MAIN MENU</button>
        </div>
        <div style="margin-top: 30px; font-size: 24px; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">
            You are a true parkour legend!
        </div>
    </div>

    <!-- Game Container -->
    <div id="gameContainer" class="hidden">
    <button id="shopButton" onclick="event.stopPropagation(); backToMenu();">üè† MENU</button>
    <div id="hud">
        <div class="stat">
            <div class="stat-label">GEMS</div>
            <div class="stat-value" id="gemDisplay">0</div>
        </div>
        <div class="stat">
            <div class="stat-label">LEVEL</div>
            <div class="stat-value" id="levelDisplay">1</div>
        </div>
        <div class="stat">
            <div class="stat-label">DIFFICULTY</div>
            <div class="stat-value" id="difficultyDisplay"></div>
        </div>
        <div class="stat">
            <div class="stat-label">TIME</div>
            <div class="stat-value" id="timeDisplay">0.0s</div>
        </div>
        <div class="stat">
            <div class="stat-label">DEATHS</div>
            <div class="stat-value" id="deathDisplay">0</div>
        </div>
    </div>
    <canvas id="gameCanvas" width="800" height="500"></canvas>
    <div id="controls">
        <h3>Controls</h3>
        <span class="key">‚Üê ‚Üí</span> Move
        <span class="key">SPACE</span> or <span class="key">‚Üë</span> Jump
        <span class="key">R</span> Restart Level
        <br><br>
        <strong>Complete all 1000 levels!</strong>
    </div>
    <div id="message"></div>
    </div>
    <!-- End Game Container -->

    <!-- Shop Modal -->
    <div id="shopModal">
        <div class="shop-content">
            <h2 class="shop-title">üõçÔ∏è SKIN SHOP üõçÔ∏è</h2>
            <div class="gem-balance">
                <span class="gem-icon">üíé</span> <span id="shopGemBalance">0</span> Gems
            </div>
            <div class="skins-grid" id="skinsGrid"></div>
            <button class="close-shop" onclick="closeShop()">CLOSE SHOP</button>
        </div>
    </div>

    <!-- Levels Modal -->
    <div id="levelsModal">
        <div class="levels-content">
            <h2 class="levels-title">üìã LEVEL SELECT üìã</h2>
            <p style="text-align: center; color: white; font-size: 18px; margin-bottom: 20px;">
                Highest Level: <strong id="highestLevel">1</strong> | Total Gems: <strong id="totalGemsDisplay">0</strong> üíé
            </p>
            <div class="levels-grid" id="levelsGrid"></div>
            <button class="back-button" onclick="closeLevels()">BACK TO MENU</button>
        </div>
    </div>

    <script>
        let gameStarted = false;
        let totalGameTime = 0;
        let gems = 0;
        let equippedSkin = 'default';
        let highestLevel = 1;
        let completedLevels = {};
        let fromMenu = false;
        let musicEnabled = false;
        let audioContext;
        let musicGainNode;
        let musicOscillators = [];

        // Initialize Web Audio API for music
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                musicGainNode = audioContext.createGain();
                musicGainNode.connect(audioContext.destination);
                musicGainNode.gain.value = 0.15;
            }
        }

        let musicInterval = null;

        // Simple background music using Web Audio API
        function playBackgroundMusic() {
            if (!musicEnabled || !audioContext) return;
            
            stopBackgroundMusic();
            
            // Create a simple melody with oscillators
            const notes = [
                { freq: 523.25, time: 0 },    // C5
                { freq: 587.33, time: 0.25 }, // D5
                { freq: 659.25, time: 0.5 },  // E5
                { freq: 698.46, time: 0.75 }, // F5
                { freq: 783.99, time: 1 },    // G5
                { freq: 659.25, time: 1.25 }, // E5
                { freq: 587.33, time: 1.5 },  // D5
                { freq: 523.25, time: 1.75 }  // C5
            ];
            
            function createMelody() {
                if (!musicEnabled) return;
                
                const now = audioContext.currentTime;
                notes.forEach(note => {
                    const osc = audioContext.createOscillator();
                    const noteGain = audioContext.createGain();
                    
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(note.freq, now + note.time);
                    
                    noteGain.gain.setValueAtTime(0, now + note.time);
                    noteGain.gain.linearRampToValueAtTime(0.1, now + note.time + 0.01);
                    noteGain.gain.linearRampToValueAtTime(0, now + note.time + 0.2);
                    
                    osc.connect(noteGain);
                    noteGain.connect(musicGainNode);
                    
                    osc.start(now + note.time);
                    osc.stop(now + note.time + 0.3);
                    
                    musicOscillators.push(osc);
                });
            }
            
            createMelody();
            
            // Loop the music every 2 seconds
            musicInterval = setInterval(() => {
                if (!musicEnabled) {
                    clearInterval(musicInterval);
                    musicInterval = null;
                    return;
                }
                createMelody();
            }, 2000);
        }

        function stopBackgroundMusic() {
            if (musicInterval) {
                clearInterval(musicInterval);
                musicInterval = null;
            }
            musicOscillators.forEach(osc => {
                try {
                    osc.stop();
                } catch (e) {}
            });
            musicOscillators = [];
        }

        function toggleMusic() {
            initAudio();
            musicEnabled = !musicEnabled;
            document.getElementById('musicStatus').textContent = musicEnabled ? 'ON' : 'OFF';
            
            if (musicEnabled) {
                playBackgroundMusic();
            } else {
                stopBackgroundMusic();
            }
            
            saveGameData();
        }

        function playSound(frequency, duration) {
            if (!musicEnabled || !audioContext) return;
            
            const osc = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            osc.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            osc.frequency.value = frequency;
            osc.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            
            osc.start(audioContext.currentTime);
            osc.stop(audioContext.currentTime + duration);
        }

        // Skin system with detailed designs
        const skins = {
            default: { 
                name: 'Classic', 
                color: '#FF6B6B', 
                pattern: 'üî¥',
                price: 0, 
                owned: true,
                description: 'The original parkour runner'
            },
            ninja: { 
                name: 'Ninja', 
                color: '#2C3E50',
                pattern: 'ü•∑',
                price: 50, 
                owned: false,
                description: 'Silent and deadly'
            },
            golden: { 
                name: 'Golden', 
                color: '#FFD700',
                pattern: '‚≠ê',
                price: 100, 
                owned: false,
                description: 'Shine like a champion'
            },
            emerald: { 
                name: 'Emerald', 
                color: '#2ECC71',
                pattern: 'üíö',
                price: 150, 
                owned: false,
                description: 'Nature\'s power'
            },
            sapphire: { 
                name: 'Sapphire', 
                color: '#3498DB',
                pattern: 'üíô',
                price: 200, 
                owned: false,
                description: 'Ocean depths'
            },
            ruby: { 
                name: 'Ruby', 
                color: '#E74C3C',
                pattern: '‚ù§Ô∏è',
                price: 250, 
                owned: false,
                description: 'Burning passion'
            },
            shadow: { 
                name: 'Shadow', 
                color: '#34495E',
                pattern: 'üåë',
                price: 300, 
                owned: false,
                description: 'Master of darkness'
            },
            rainbow: { 
                name: 'Rainbow', 
                color: '#9B59B6',
                pattern: 'üåà',
                price: 500, 
                owned: false,
                description: 'All colors combined'
            },
            galaxy: { 
                name: 'Galaxy', 
                color: '#5C4D7D',
                pattern: 'üåå',
                price: 750, 
                owned: false,
                description: 'Cosmic explorer'
            },
            diamond: { 
                name: 'Diamond', 
                color: '#ECF0F1',
                pattern: 'üíé',
                price: 1000, 
                owned: false,
                description: 'Ultimate prestige'
            }
        };

        function loadGameData() {
            const saved = localStorage.getItem('parkourGameData');
            if (saved) {
                const data = JSON.parse(saved);
                gems = data.gems || 0;
                equippedSkin = data.equippedSkin || 'default';
                highestLevel = data.highestLevel || 1;
                completedLevels = data.completedLevels || {};
                musicEnabled = data.musicEnabled === true; // Only true if explicitly saved as true
                if (data.ownedSkins) {
                    Object.keys(data.ownedSkins).forEach(skinId => {
                        if (skins[skinId]) {
                            skins[skinId].owned = data.ownedSkins[skinId];
                        }
                    });
                }
            }
            document.getElementById('musicStatus').textContent = musicEnabled ? 'ON' : 'OFF';
        }

        function saveGameData() {
            const ownedSkins = {};
            Object.keys(skins).forEach(skinId => {
                ownedSkins[skinId] = skins[skinId].owned;
            });
            
            localStorage.setItem('parkourGameData', JSON.stringify({
                gems: gems,
                equippedSkin: equippedSkin,
                ownedSkins: ownedSkins,
                highestLevel: highestLevel,
                completedLevels: completedLevels,
                musicEnabled: musicEnabled
            }));
        }

        function addGems(amount) {
            gems += amount;
            updateGemDisplay();
            saveGameData();
        }

        function updateGemDisplay() {
            document.getElementById('gemDisplay').textContent = gems;
            document.getElementById('shopGemBalance').textContent = gems;
            document.getElementById('totalGemsDisplay').textContent = gems;
        }

        function openShopFromMenu() {
            fromMenu = true;
            loadGameData();
            updateGemDisplay();
            openShop();
        }

        function openShop() {
            document.getElementById('shopModal').style.display = 'flex';
            renderShop();
        }

        function closeShop() {
            document.getElementById('shopModal').style.display = 'none';
            if (fromMenu) {
                fromMenu = false;
            }
        }

        function openLevels() {
            loadGameData();
            document.getElementById('levelsModal').style.display = 'flex';
            renderLevels();
        }

        function closeLevels() {
            document.getElementById('levelsModal').style.display = 'none';
        }

        function renderLevels() {
            const grid = document.getElementById('levelsGrid');
            grid.innerHTML = '';
            
            document.getElementById('highestLevel').textContent = highestLevel;
            document.getElementById('totalGemsDisplay').textContent = gems;
            
            for (let i = 1; i <= Math.min(highestLevel + 5, 1000); i++) {
                const button = document.createElement('button');
                button.className = 'level-button';
                
                const isCompleted = completedLevels[i];
                const isCurrent = i === currentLevel;
                const isLocked = i > highestLevel;
                
                if (isCompleted) button.classList.add('completed');
                if (isCurrent) button.classList.add('current');
                if (isLocked) button.classList.add('locked');
                
                let gemsInfo = '';
                if (isCompleted && completedLevels[i].gems) {
                    const gemsCollected = completedLevels[i].gems;
                    gemsInfo = `<span class="level-gems">${gemsCollected}/3 üíé</span>`;
                }
                
                button.innerHTML = `${i}${gemsInfo}`;
                
                if (!isLocked) {
                    button.onclick = () => selectLevel(i);
                }
                
                grid.appendChild(button);
            }
        }

        function selectLevel(level) {
            currentLevel = level;
            closeLevels();
            startGame();
        }

        function renderShop() {
            const grid = document.getElementById('skinsGrid');
            grid.innerHTML = '';
            
            Object.keys(skins).forEach(skinId => {
                const skin = skins[skinId];
                const card = document.createElement('div');
                card.className = 'skin-card';
                if (skin.owned) card.classList.add('owned');
                if (equippedSkin === skinId) card.classList.add('equipped');
                
                card.innerHTML = `
                    <div class="skin-preview" style="background: ${skin.color}">
                        <div class="skin-pattern">${skin.pattern}</div>
                    </div>
                    <div class="skin-name">${skin.name}</div>
                    <div class="skin-price">${skin.price === 0 ? 'Free' : 'üíé ' + skin.price}</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.8); margin-bottom: 10px; min-height: 30px;">${skin.description}</div>
                    ${getButtonHTML(skinId, skin)}
                `;
                
                grid.appendChild(card);
            });
        }

        function getButtonHTML(skinId, skin) {
            if (equippedSkin === skinId) {
                return '<button class="skin-button equipped-button">EQUIPPED</button>';
            } else if (skin.owned) {
                return `<button class="skin-button equip-button" onclick="equipSkin('${skinId}')">EQUIP</button>`;
            } else {
                return `<button class="skin-button buy-button" onclick="buySkin('${skinId}')">BUY</button>`;
            }
        }

        function buySkin(skinId) {
            const skin = skins[skinId];
            if (gems >= skin.price) {
                gems -= skin.price;
                skin.owned = true;
                updateGemDisplay();
                saveGameData();
                renderShop();
                showMessage(`Unlocked ${skin.name}! üéâ`, 1500);
            } else {
                showMessage(`Need ${skin.price - gems} more gems! üíé`, 1500);
            }
        }

        function equipSkin(skinId) {
            equippedSkin = skinId;
            player.color = skins[skinId].color;
            saveGameData();
            renderShop();
            showMessage(`${skins[skinId].name} equipped! ‚ú®`, 1500);
        }

        function startGame() {
            document.getElementById('titleScreen').classList.add('hidden');
            document.getElementById('gameContainer').classList.remove('hidden');
            document.getElementById('shopButton').classList.add('show');
            gameStarted = true;
            loadGameData();
            player.color = skins[equippedSkin].color;
            updateGemDisplay();
            generateLevel(currentLevel);
            levelStartTime = Date.now();
            
            if (musicEnabled) {
                initAudio();
                playBackgroundMusic();
            }
        }

        function backToMenu() {
            document.getElementById('gameContainer').classList.add('hidden');
            document.getElementById('titleScreen').classList.remove('hidden');
            document.getElementById('shopButton').classList.remove('show');
            gameStarted = false;
            saveGameData();
            // Update the music status display
            document.getElementById('musicStatus').textContent = musicEnabled ? 'ON' : 'OFF';
            // Restart music if it was enabled
            if (musicEnabled) {
                stopBackgroundMusic();
                playBackgroundMusic();
            }
        }

        function backToMenuFromEnd() {
            stopBackgroundMusic();
            document.getElementById('endingScreen').style.display = 'none';
            document.getElementById('titleScreen').classList.remove('hidden');
            gameStarted = false;
        }

        function showEndingScreen() {
            document.getElementById('endingScreen').style.display = 'flex';
            document.getElementById('finalLevel').textContent = currentLevel;
            document.getElementById('finalDeaths').textContent = totalDeaths;
            
            const totalSeconds = Math.floor((Date.now() - (levelStartTime - elapsedTime * 1000)) / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            document.getElementById('finalTime').textContent = 
                `${hours}h ${minutes}m ${seconds}s`;
        }

        function playAgain() {
            location.reload();
        }
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const message = document.getElementById('message');

        // Game state
        let currentLevel = 1;
        let totalDeaths = 0;
        let levelStartTime = 0;
        let elapsedTime = 0;

        // Player
        const player = {
            x: 50,
            y: 300,
            width: 25,
            height: 25,
            velocityX: 0,
            velocityY: 0,
            speed: 5,
            jumpPower: 11,
            grounded: false,
            color: '#FF6B6B'
        };

        let platforms = [];
        let spikes = [];
        let movingPlatforms = [];
        let finish = {};
        let lava = [];
        let gems_objects = [];

        const gravity = 0.45;
        const keys = {};

        window.addEventListener('keydown', (e) => {
            keys[e.key] = true;
            if (e.key === 'r' || e.key === 'R') {
                resetLevel();
            }
            if (e.key === 'Escape') {
                backToMenu();
            }
        });

        window.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });

        function getDifficulty(level) {
            if (level <= 100) return { name: 'EASY', class: 'easy' };
            if (level <= 300) return { name: 'MEDIUM', class: 'medium' };
            if (level <= 600) return { name: 'HARD', class: 'hard' };
            if (level <= 900) return { name: 'EXTREME', class: 'extreme' };
            return { name: 'IMPOSSIBLE', class: 'impossible' };
        }

        function seededRandom(seed) {
            const x = Math.sin(seed++) * 10000;
            return x - Math.floor(x);
        }

        function generateLevel(level) {
            platforms = [];
            spikes = [];
            movingPlatforms = [];
            lava = [];
            gems_objects = [];

            // Difficulty scaling
            const difficulty = Math.min(level / 100, 10);
            const gapIncrease = difficulty * 15;
            const spikeCount = Math.floor(2 + difficulty * 1.5);
            const movingPlatformCount = Math.floor(difficulty / 2);
            const platformCount = 8 + Math.floor(level / 50);
            
            // Starting platform
            platforms.push({ x: 0, y: 450, width: 150, height: 50 });

            let currentX = 150;
            let currentY = 400;

            // Generate platforms
            for (let i = 0; i < platformCount; i++) {
                const seed = level * 1000 + i;
                const gapSize = 80 + gapIncrease + seededRandom(seed) * 100;
                const heightChange = (seededRandom(seed + 1) - 0.5) * 120;
                const platformWidth = 80 + seededRandom(seed + 2) * (100 - difficulty * 5);

                currentX += gapSize;
                currentY = Math.max(100, Math.min(430, currentY + heightChange));

                if (currentX < 750) {
                    platforms.push({
                        x: currentX,
                        y: currentY,
                        width: platformWidth,
                        height: 20
                    });
                }
            }

            // Add spikes on platforms
            for (let i = 0; i < spikeCount && i < platforms.length - 1; i++) {
                const seed = level * 2000 + i;
                const platformIndex = 1 + Math.floor(seededRandom(seed) * (platforms.length - 2));
                const platform = platforms[platformIndex];
                
                spikes.push({
                    x: platform.x + seededRandom(seed + 1) * (platform.width - 40),
                    y: platform.y - 15,
                    width: 30,
                    height: 15
                });
            }

            // Add moving platforms
            for (let i = 0; i < movingPlatformCount; i++) {
                const seed = level * 3000 + i;
                const startX = 200 + seededRandom(seed) * 300;
                const startY = 150 + seededRandom(seed + 1) * 200;
                
                movingPlatforms.push({
                    x: startX,
                    y: startY,
                    width: 80,
                    height: 15,
                    velocityX: 1 + difficulty * 0.3,
                    minX: startX - 100,
                    maxX: startX + 100
                });
            }

            // Add lava at bottom (higher levels)
            if (level > 50) {
                lava.push({
                    x: 0,
                    y: 470,
                    width: 800,
                    height: 30
                });
            }

            // Add gems to collect - 3 gems per level
            const gemPlatforms = platforms.slice(1, -1);
            for (let i = 0; i < Math.min(3, gemPlatforms.length); i++) {
                const seed = level * 4000 + i;
                const platformIndex = Math.floor(seededRandom(seed) * gemPlatforms.length);
                const platform = gemPlatforms[platformIndex];
                
                // Check if this gem was already collected in this level
                const gemCollected = completedLevels[level] && completedLevels[level].collectedGems && completedLevels[level].collectedGems[i];
                
                gems_objects.push({
                    x: platform.x + platform.width / 2 - 10,
                    y: platform.y - 40,
                    width: 20,
                    height: 20,
                    collected: gemCollected || false,
                    id: i
                });
            }

            // Finish flag - place on last platform
            const lastPlatform = platforms[platforms.length - 1];
            finish = {
                x: lastPlatform.x + lastPlatform.width / 2 - 15,
                y: lastPlatform.y - 50,
                width: 30,
                height: 50
            };

            resetPlayerPosition();
            levelStartTime = Date.now();
        }

        function resetPlayerPosition() {
            player.x = 50;
            player.y = 350;
            player.velocityX = 0;
            player.velocityY = 0;
        }

        function resetLevel() {
            totalDeaths++;
            resetPlayerPosition();
            showMessage('üíÄ Try Again!', 800);
            updateHUD();
            playSound(200, 0.2); // Death sound
        }

        function nextLevel() {
            // Track completed level and collected gems
            const collectedGems = {};
            gems_objects.forEach(gem => {
                if (gem.collected) {
                    collectedGems[gem.id] = true;
                }
            });
            
            if (!completedLevels[currentLevel]) {
                completedLevels[currentLevel] = {};
            }
            
            completedLevels[currentLevel].completed = true;
            completedLevels[currentLevel].gems = Object.keys(collectedGems).length;
            
            // Merge with existing collected gems
            if (!completedLevels[currentLevel].collectedGems) {
                completedLevels[currentLevel].collectedGems = {};
            }
            Object.assign(completedLevels[currentLevel].collectedGems, collectedGems);
            
            if (currentLevel >= highestLevel) {
                highestLevel = currentLevel + 1;
            }
            
            saveGameData();
            
            if (currentLevel >= 1000) {
                showMessage('üéâ YOU BEAT ALL 1000 LEVELS! üéâ', 3000);
                playSound(800, 0.5); // Victory sound
                setTimeout(() => {
                    showEndingScreen();
                }, 3000);
                return;
            }
            
            currentLevel++;
            generateLevel(currentLevel);
            showMessage(`Level ${currentLevel}!`, 1000);
            updateHUD();
            playSound(600, 0.3); // Level complete sound
        }

        function showMessage(text, duration) {
            message.textContent = text;
            setTimeout(() => message.textContent = '', duration);
        }

        function updateHUD() {
            document.getElementById('levelDisplay').textContent = currentLevel + ' / 1000';
            document.getElementById('deathDisplay').textContent = totalDeaths;
            
            const diff = getDifficulty(currentLevel);
            const diffDisplay = document.getElementById('difficultyDisplay');
            diffDisplay.textContent = diff.name;
            diffDisplay.className = 'stat-value difficulty-indicator ' + diff.class;
        }

        function drawPlayer() {
            const skin = skins[equippedSkin];
            
            // Draw player body
            ctx.fillStyle = player.color;
            ctx.fillRect(player.x, player.y, player.width, player.height);
            
            // Draw pattern/emoji on player if available
            if (skin.pattern && skin.pattern.length > 1) {
                ctx.font = '20px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(skin.pattern, player.x + player.width/2, player.y + player.height/2);
            } else {
                // Draw eyes
                ctx.fillStyle = 'white';
                ctx.fillRect(player.x + 6, player.y + 6, 5, 5);
                ctx.fillRect(player.x + 14, player.y + 6, 5, 5);
                ctx.fillStyle = 'black';
                ctx.fillRect(player.x + 7, player.y + 7, 3, 3);
                ctx.fillRect(player.x + 15, player.y + 7, 3, 3);
            }
        }

        function drawPlatforms() {
            ctx.fillStyle = '#8B4513';
            platforms.forEach(platform => {
                ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
                ctx.strokeStyle = '#654321';
                ctx.lineWidth = 2;
                ctx.strokeRect(platform.x, platform.y, platform.width, platform.height);
            });
        }

        function drawSpikes() {
            spikes.forEach(spike => {
                ctx.fillStyle = '#DC143C';
                ctx.beginPath();
                ctx.moveTo(spike.x, spike.y + spike.height);
                ctx.lineTo(spike.x + spike.width / 2, spike.y);
                ctx.lineTo(spike.x + spike.width, spike.y + spike.height);
                ctx.closePath();
                ctx.fill();
                ctx.strokeStyle = '#8B0000';
                ctx.lineWidth = 2;
                ctx.stroke();
            });
        }

        function drawMovingPlatforms() {
            ctx.fillStyle = '#4169E1';
            movingPlatforms.forEach(platform => {
                ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
                ctx.strokeStyle = '#1E3A8A';
                ctx.lineWidth = 2;
                ctx.strokeRect(platform.x, platform.y, platform.width, platform.height);
            });
        }

        function drawLava() {
            lava.forEach(l => {
                const gradient = ctx.createLinearGradient(0, l.y, 0, l.y + l.height);
                gradient.addColorStop(0, '#FF4500');
                gradient.addColorStop(0.5, '#FF6347');
                gradient.addColorStop(1, '#FF8C00');
                ctx.fillStyle = gradient;
                ctx.fillRect(l.x, l.y, l.width, l.height);
            });
        }

        function drawFinish() {
            // Flag pole
            ctx.fillStyle = '#654321';
            ctx.fillRect(finish.x + 12, finish.y, 6, finish.height);
            
            // Flag
            ctx.fillStyle = '#FFD700';
            ctx.beginPath();
            ctx.moveTo(finish.x + 18, finish.y + 5);
            ctx.lineTo(finish.x + 35, finish.y + 15);
            ctx.lineTo(finish.x + 18, finish.y + 25);
            ctx.closePath();
            ctx.fill();
            
            ctx.strokeStyle = '#FFA500';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // Make it more visible with glow effect
            ctx.shadowBlur = 10;
            ctx.shadowColor = '#FFD700';
            ctx.fillStyle = '#FFD700';
            ctx.beginPath();
            ctx.moveTo(finish.x + 18, finish.y + 5);
            ctx.lineTo(finish.x + 35, finish.y + 15);
            ctx.lineTo(finish.x + 18, finish.y + 25);
            ctx.closePath();
            ctx.fill();
            ctx.shadowBlur = 0;
        }

        function drawGems() {
            gems_objects.forEach(gem => {
                if (!gem.collected) {
                    // Draw rotating gem
                    ctx.save();
                    ctx.translate(gem.x + gem.width/2, gem.y + gem.height/2);
                    ctx.rotate(Date.now() / 500);
                    
                    // Gem shape
                    ctx.fillStyle = '#00CED1';
                    ctx.beginPath();
                    ctx.moveTo(0, -10);
                    ctx.lineTo(8, -3);
                    ctx.lineTo(8, 3);
                    ctx.lineTo(0, 10);
                    ctx.lineTo(-8, 3);
                    ctx.lineTo(-8, -3);
                    ctx.closePath();
                    ctx.fill();
                    
                    // Gem outline
                    ctx.strokeStyle = '#008B8B';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    
                    // Shine effect
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
                    ctx.beginPath();
                    ctx.arc(-2, -3, 3, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.restore();
                }
            });
        }

        function checkCollision(rect1, rect2) {
            return rect1.x < rect2.x + rect2.width &&
                   rect1.x + rect1.width > rect2.x &&
                   rect1.y < rect2.y + rect2.height &&
                   rect1.y + rect1.height > rect2.y;
        }

        function update() {
            if (keys['ArrowLeft'] || keys['a']) {
                player.velocityX = -player.speed;
            } else if (keys['ArrowRight'] || keys['d']) {
                player.velocityX = player.speed;
            } else {
                player.velocityX = 0;
            }

            if ((keys['ArrowUp'] || keys[' '] || keys['w']) && player.grounded) {
                player.velocityY = -player.jumpPower;
                player.grounded = false;
            }

            player.velocityY += gravity;
            player.x += player.velocityX;
            player.y += player.velocityY;

            player.grounded = false;

            platforms.forEach(platform => {
                if (checkCollision(player, platform)) {
                    if (player.velocityY > 0 && player.y + player.height - player.velocityY <= platform.y + 5) {
                        player.y = platform.y - player.height;
                        player.velocityY = 0;
                        player.grounded = true;
                    }
                }
            });

            movingPlatforms.forEach(platform => {
                platform.x += platform.velocityX;
                if (platform.x <= platform.minX || platform.x >= platform.maxX) {
                    platform.velocityX *= -1;
                }

                if (checkCollision(player, platform)) {
                    if (player.velocityY > 0 && player.y + player.height - player.velocityY <= platform.y + 5) {
                        player.y = platform.y - player.height;
                        player.velocityY = 0;
                        player.grounded = true;
                        player.x += platform.velocityX;
                    }
                }
            });

            spikes.forEach(spike => {
                if (checkCollision(player, spike)) {
                    resetLevel();
                }
            });

            lava.forEach(l => {
                if (checkCollision(player, l)) {
                    resetLevel();
                }
            });

            // Check gem collection
            gems_objects.forEach(gem => {
                if (!gem.collected && checkCollision(player, gem)) {
                    gem.collected = true;
                    
                    // Save which gems have been collected for this level
                    if (!completedLevels[currentLevel]) {
                        completedLevels[currentLevel] = { collectedGems: {} };
                    }
                    if (!completedLevels[currentLevel].collectedGems) {
                        completedLevels[currentLevel].collectedGems = {};
                    }
                    completedLevels[currentLevel].collectedGems[gem.id] = true;
                    
                    addGems(1);
                    showMessage('+1 üíé', 500);
                    playSound(800, 0.1); // Gem collect sound
                    saveGameData();
                }
            });

            if (checkCollision(player, finish)) {
                nextLevel();
            }

            if (player.x < 0) {
                // Go back to previous level if available
                if (currentLevel > 1) {
                    currentLevel--;
                    generateLevel(currentLevel);
                    showMessage(`Level ${currentLevel}`, 1000);
                    updateHUD();
                    playSound(500, 0.2);
                    // Start player at the beginning (left side)
                    player.x = 50;
                    player.y = 350;
                    player.velocityX = 0;
                    player.velocityY = 0;
                } else {
                    player.x = 0;
                }
            }
            if (player.x + player.width > canvas.width) player.x = canvas.width - player.width;
            
            if (player.y > canvas.height) {
                resetLevel();
            }

            elapsedTime = ((Date.now() - levelStartTime) / 1000).toFixed(1);
            document.getElementById('timeDisplay').textContent = elapsedTime + 's';
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#87CEEB');
            gradient.addColorStop(1, '#E0F6FF');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            drawPlatforms();
            drawMovingPlatforms();
            drawLava();
            drawGems();
            drawSpikes();
            drawFinish();
            drawPlayer();
        }

        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        generateLevel(currentLevel);
        updateHUD();
        loadGameData();
        updateGemDisplay();
        document.getElementById('musicStatus').textContent = musicEnabled ? 'ON' : 'OFF';
        gameLoop();
    </script>
</body>
</html>
